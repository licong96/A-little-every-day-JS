/**
 * fis.baidu.com
 */

'use strict';

var _ = fis.util;
var translate = {};
var ld, rd; //smarty delimiter

var exports = module.exports = function(ret, conf, settings, opt) {
    if (settings.enable !== true) {
        return;
    }

    ld = settings.left_delimiter;
    rd = settings.right_delimiter;
    //init
    translate = {};

    _.map(ret.ids, function(id, file) {
        if (file.isJsLike) {
            replace(file);
        }
    });

    var get = {};
    var items = [];

    _.map(translate, function(key, value) {
        if (!get[key]) {
            items.push('    "'+key+'":' + value);
        }
        get[key] = true;
    });
    

    if (items.length) {
        var root = fis.project.getProjectPath();
        var file = fis.file.wrap(root + '/widget/fis_translate.tpl');

        var content = '<script type="text/javascript">\nF.context({\n';
            content += items.join(',\n');
            content += '\n});\n</script>';

        file.setContent(content);

        file.isMod = true;
        file.useCompile = false;

        //map.json 添加translate.tpl
        ret.map.res[file.getId()] = {
            uri  : file.getUrl(opt.hash, opt.domain),
            type : file.rExt.replace(/^\./, '')
        };

        //translate.tpl产出
        ret.pkg[file.subpath] = file;
    } 
};

exports.defaultOptions = {
    'left_delimiter': fis.config.get('settings.smarty.left_delimiter') || '{%',
    'right_delimiter': fis.config.get('settings.smarty.right_delimiter') || '%}',
    'enable': false
};


function replace(file) {
    var content = file.getContent();
    var reg = /"(?:[^\\"\r\n\f]|\\[\s\S])*"|'(?:[^\\'\n\r\f]|\\[\s\S])*'|(\/\/[^\r\n\f]+|\/\*[\s\S]*?(?:\*\/|$))|\b(__)\(\s*("(?:[^\\"\r\n\f]|\\[\s\S])*"|'(?:[^\\'\n\r\f]|\\[\s\S])*')\s*\)/g; 
    content = content.replace(reg, function(m, comment, type, value) {
        if (type) {
            switch (type) {
                case '__':
                    var str = value.substr(1, value.length - 2);
                    var md5 = _.md5(str);
                    var info = _.stringQuote(value);
                    //translate[md5] = info.quote + ld + '__("' + str + '")' + rd + info.quote;
                    translate[md5] = info.quote + ld + '"'+str+'"|gettext' + rd + info.quote;
                    m = 'F.context("' + md5 + '")';
                    break;
            }
        }

        return m;
    });
    file.setContent(content);
}
